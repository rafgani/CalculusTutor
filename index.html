<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socratic Calculus Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- KaTeX for rendering mathematical formulas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMcAgsccshIocO3C4fRnsFe5SONALBOPflAPPktAF55IJWeRo" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose {
            color: #374151;
        }
        .dark .prose {
            color: #d1d5db;
        }
        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: #1f2937;
        }
        .dark .prose h1, .dark .prose h2, .dark .prose h3, .dark .prose h4 {
            color: #f9fafb;
        }
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 1rem 0;
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 dark:text-white">The Socratic Calculus Tutor</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Let us reason through the tasks below.</p>
        </header>

        <main class="space-y-12">
            <!-- Task 1 Block -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Task 1: Understanding Functions</h2>
                <div class="prose prose-lg max-w-none dark:text-gray-300 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <p>Consider the rule $y = \sqrt{x}$. Is this a function? Why or why not? What is its domain (the set of allowed $x$ values)?</p>
                </div>
                
                <!-- Dialogue for Task 1 -->
                <div class="mt-6">
                     <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">Our Dialogue on Task 1</h3>
                     <div id="dialogue-history-1" class="space-y-6"></div>
                     <div id="loading-indicator-1" class="hidden mt-6 flex items-center text-gray-600 dark:text-gray-400">
                        <div class="spinner mr-3"></div>
                        <span>Socrates is pondering...</span>
                    </div>
                     <div class="mt-6">
                        <textarea id="prompt-input-1" rows="3" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition duration-150" placeholder="Share your thoughts on Task 1..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button data-task="1" class="generate-button bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800 transition duration-150 flex items-center">Inquire</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task 2 Block -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Task 2: Understanding Intervals</h2>
                <div class="prose prose-lg max-w-none dark:text-gray-300 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <p>Describe the set of all numbers $x$ such that $-2 < x \le 5$ using interval notation. Is this interval open, closed, or half-open?</p>
                </div>

                <!-- Dialogue for Task 2 -->
                 <div class="mt-6">
                     <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">Our Dialogue on Task 2</h3>
                     <div id="dialogue-history-2" class="space-y-6"></div>
                     <div id="loading-indicator-2" class="hidden mt-6 flex items-center text-gray-600 dark:text-gray-400">
                        <div class="spinner mr-3"></div>
                        <span>Socrates is pondering...</span>
                    </div>
                     <div class="mt-6">
                        <textarea id="prompt-input-2" rows="3" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition duration-150" placeholder="Share your thoughts on Task 2..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button data-task="2" class="generate-button bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800 transition duration-150 flex items-center">Inquire</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error Message Box -->
            <div id="error-message" class="hidden mt-8 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">A moment of difficulty:</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>
        </main>
    </div>

    <script>
        // --- State ---
        let chatHistories = {
            '1': [{ role: "model", parts: [{ text: "Greetings. Let us examine this first task together. What are your initial thoughts on the rule $y = \\sqrt{x}$?" }] }],
            '2': [{ role: "model", parts: [{ text: "A worthy question. How shall we represent this range of numbers? What does the notation tell us?" }] }]
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initializeChat);
        document.querySelectorAll('.generate-button').forEach(button => {
            button.addEventListener('click', () => handleInquiry(button.dataset.task));
        });
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    handleInquiry(event.target.id.split('-')[2]);
                }
            });
        });

        /**
         * Initializes the chat interfaces on page load.
         */
        function initializeChat() {
            for (const task in chatHistories) {
                const history = chatHistories[task];
                history.forEach(message => {
                    appendMessage(task, message.role, message.parts[0].text);
                });
            }
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}
                    ]
                });
            }
        }

        async function handleInquiry(task) {
            const promptInput = document.getElementById(`prompt-input-${task}`);
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                showError("You must venture a thought before we can proceed.");
                return;
            }

            appendMessage(task, 'user', userPrompt);
            chatHistories[task].push({ role: "user", parts: [{ text: userPrompt }] });
            promptInput.value = '';

            const loadingIndicator = document.getElementById(`loading-indicator-${task}`);
            const generateButton = document.querySelector(`button[data-task="${task}"]`);
            loadingIndicator.classList.remove('hidden');
            document.getElementById('error-message').classList.add('hidden');
            generateButton.disabled = true;
            generateButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                await callGeminiApi(task);
            } catch (error) {
                console.error(`Error calling Gemini API for task ${task}:`, error);
                showError(error.message || "An unknown obstacle has appeared on our path.");
                chatHistories[task].pop();
            } finally {
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Calls the Gemini API with the relevant chat history.
         */
        async function callGeminiApi(task) {
            const taskPrompts = {
                '1': `You are a Socratic calculus tutor. Guide the student in solving Task 1: "Consider the rule y = sqrt(x). Is this a function? Why or why not? What is its domain (the set of allowed x values)?". Use the Socratic method. Never give direct answers. Ask probing questions to lead them to the solution. Maintain a patient, wise persona. Use LaTeX for math.`,
                '2': `You are a Socratic calculus tutor. Guide the student in solving Task 2: "Describe the set of all numbers x such that -2 < x <= 5 using interval notation. Is this interval open, closed, or half-open?". Use the Socratic method. Never give direct answers. Ask probing questions to lead them to the solution. Maintain a patient, wise persona. Use LaTeX for math.`
            };

            const apiKey = "AIzaSyClqwGPmPxd13JFi45j1cNsk3n6HY7--9E";
            if (apiKey === "YOUR_API_KEY_HERE") {
                showError("Please replace 'YOUR_API_KEY_HERE' with your actual API key in the code.");
                throw new Error("API key not set.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const requestBody = {
                contents: chatHistories[task],
                systemInstruction: { parts: [{ text: taskPrompts[task] }] }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
            }

            const responseData = await response.json();
            
            if (responseData.candidates?.[0]?.content?.parts?.[0]) {
                const generatedText = responseData.candidates[0].content.parts[0].text;
                appendMessage(task, 'model', generatedText);
                chatHistories[task].push({ role: "model", parts: [{ text: generatedText }] });
            } else {
                console.error("Unexpected API response structure:", responseData);
                throw new Error("Could not extract text from the API response.");
            }
        }
        
        /**
         * Appends a message to the correct dialogue UI.
         */
        function appendMessage(task, role, text) {
            const dialogueHistoryEl = document.getElementById(`dialogue-history-${task}`);
            const messageWrapper = document.createElement('div');
            const roleIndicator = document.createElement('div');
            roleIndicator.classList.add('font-bold', 'text-sm', 'mb-1', 'capitalize');
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('prose', 'prose-lg', 'max-w-none', 'dark:text-gray-300');

            if (role === 'user') {
                roleIndicator.textContent = 'You';
                roleIndicator.classList.add('text-indigo-600', 'dark:text-indigo-400');
                contentDiv.textContent = text;
            } else { // 'model'
                roleIndicator.textContent = 'Socrates';
                roleIndicator.classList.add('text-gray-700', 'dark:text-gray-400');
                contentDiv.innerHTML = marked.parse(text);
                if (window.renderMathInElement) {
                    window.renderMathInElement(contentDiv, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}
                        ]
                    });
                }
            }
            
            messageWrapper.appendChild(roleIndicator);
            messageWrapper.appendChild(contentDiv);
            dialogueHistoryEl.appendChild(messageWrapper);
            messageWrapper.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.classList.remove('hidden');
            errorEl.querySelector('span').textContent = message;
        }
    </script>
</body>
</html>
